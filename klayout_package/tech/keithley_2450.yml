# ==================================================================
# klab Instrument Definition File for Keithley 2450 SMU
# ==================================================================
# This file defines the command sequences for the Keithley 2450 driver.

# --- Properties ---
# Defines instrument-specific constants and settings.
properties:
  # This instrument's specific command for reading measurement data
  read_command: ":READ?"

#Staus byte parser:
  

# --- Methods ---
# Defines high-level methods as a sequence of SCPI commands.
# Arguments can be passed from Python using named placeholders like {voltage}.
methods:
  # The sequence to run upon initialization
  initialize:
    - "*RST"
    - "*CLS"
  
  # Turns the output on or off.
  enable_source:
    - ":OUTPut:STATe {state}" # Expects 'ON' or 'OFF'

  # Sets up the instrument to measure current.
  source_voltage:
    - "*RST"
    - "SENS:FUNC \"CURR\""
    - "SENS:CURR:RANG:AUTO ON"
    - "SOUR:FUNC VOLT"
    - "SOUR:DEL 0.1"
    - "SOUR:VOLT {voltage}"
    - "SOUR:VOLT:ILIM {current_compliance}"
    

  # Sets up the instrument to measure voltage.
  source_current:
    - "*RST"
    - "ROUT:TERM REAR"
    - "SENS:FUNC \"VOLT\""
    - "SENS:VOLT:RANG:AUTO ON"
    - "SOUR:FUNC CURR"
    - "SOUR:DEL 0.1"
    - "SOUR:CURR {current}"
    - "SOUR:CURR:VLIM {voltage_compliance}"
    - "OUTP OFF"

  # Setup instrument to measure resistance.
  set_resistance:
    - source_current(current={current}, voltage_compliance={voltage_compliance})
    - "SENS:VOLT:UNIT OHM"
    - "SENS:VOLT:OCOM ON"

  run_measurement:
    - "COUNT {count}"
    - "OUTP ON"
    - "TRAC:TRIG \"defbuffer1\""
    - "*WAI"
    - wait(seconds=2)
    - "TRAC:DATA? 1, {count}, \"defbuffer1\", SOUR, READ"
    - "OUTP OFF"

  meas_resistance:
    - "*CLS"
    - set_resistance(current={current}, voltage_compliance={voltage_compliance}, count={count})
    - run_measurement(count={count})